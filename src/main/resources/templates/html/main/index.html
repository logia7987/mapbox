<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <title>Mapbox</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"/>
    <script src="https://kit.fontawesome.com/872a12cba7.js" crossorigin="anonymous"></script>

    <!--Noto Sans font-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- mapbox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css' type='text/css' />
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>


    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Turf.js 추가 -->
    <script src='https://unpkg.com/@turf/turf'></script>

    <!--  proj4  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>

    <!--Spectrum-->
    <script src="https://bgrins.github.io/spectrum/spectrum.js"></script>
    <link rel='stylesheet' href='/css/spectrum.css'/>

</head>
<body>
    <div class="leftBox">
        <button type='button' class='top-btn' data-bs-toggle='modal' data-bs-target='#loadFile' title="불러오기"><i class="fa-solid fa-floppy-disk"></i></button>
        <button class="top-btn" onclick="finishPoint()"><i class="fa-solid fa-pencil"></i></button>
    </div>
    <div id="map" style="width: calc(100% - 45px); height: calc(100vh - 45px)"></div>
    <div id="loading-window">
        <div class="loading-logo" style="color:white">loading..</div>
        <div id="loading-bar"></div>
    </div>
    <div class="modal" id="myModal">
        <div th:insert="~{/html/modal/modal_attr.html::attr}"></div>
    </div>
    <div class="modal" id="loadFile">
        <div th:insert="~{/html/modal/modal_loadfile.html::loadfile}"></div>
    </div>
<!--    <div id="mode-change-btn" onclick="toggleWhiteMode()"><i class="fas fa-solid fa-moon" id="mdicon"></i></div>-->
    <div class="tab-menu">
        <div class="tab-links" onclick="openTab(event, 'tab1')" data-bs-placement="left" data-bs-toggle="tooltip" title="레이어"><i class="fa-solid fa-layer-group"></i></div>
        <div class="tab-links" onclick="openTab(event, 'tab2')" data-bs-placement="left" data-bs-toggle="tooltip" title="도구"><i class="fa-solid fa-screwdriver-wrench"></i></div>
        <div class="tab-links" onclick="openTab(event, 'tab3')" data-bs-placement="left" data-bs-toggle="tooltip" title="속성"><i class="fa-solid fa-list"></i></div>
    </div>
    <div id="tab1" class="tab" style = "display: none;">
        <h5 class="tab-title padding-10 basic-font">레이어</h5>
        <div class="layer-file-list"></div>
    </div>
    <div id="tab2" class="tab">
        <div class="map-style-change padding-10">
            <label for="map-style" class="select-label">지도 스타일</label>
            <select name="map-styles" id="map-style" >
                <option value="streets-v12" class="style-option">Streets</option>
                <option value="outdoors-v12" class="style-option">Outdoors</option>
                <option value="light-v11" class="style-option">Light</option>
                <option value="dark-v11" class="style-option">Dark</option>
                <option value="satellite-v9" class="style-option">Satellite</option>
                <option value="satellite-streets-v12" class="style-option">Satellite-streets</option>
                <option value="navigation-day-v1" class="style-option">Navigation-day</option>
                <option value="navigation-night-v1" class="style-option">Navigation-night</option>
            </select>
        </div>
        <div class="colors-plan padding-10">
            <div class="colors-item">
                <label class="select-label">폴리곤 색상</label>
                <input type="text" id="polygon-color" onchange="changePolygonColor()">
            </div>
        </div>
        <div class="colors-plan padding-10">
            <div class="line-item" title="선 색상">
                <input type="text" id="line-color" onchange="changeLineColor()" >
            </div>
            <input type="number" id="line-width" onchange="changeLineThickness()" value="2.5" title="선 굵기">
        </div>
    </div>
    <div id="tab3" class="tab">
        <h5 class="tab-title padding-10 basic-font">속성 정보</h5>
        <div class="file-class">
            <div class="file-class-tit">ID</div>
            <div class="file-class-tit">지역 코드</div>
            <div class="file-class-tit">지역명</div>
            <div class="file-class-tit">시군구</div>
        </div>
        <div class="file-properties">
            <div class="file-info-list"></div>
        </div>
    </div>
</body>
<script th:inline="javascript">
    mapboxgl.accessToken = /*[[${mapboxAccessToken}]]*/ '';

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    var fileNm;
    var dataArr = [];
    var nodeDataArr = [];
    var linkDataArr = [];
    var drawArr = []
    var fileNmList = [];
    var selectedShp;
    var polygonColor = '#1aa3ff';
    var lineColor = '#020202';
    var lineWidth = 2.5;
    var tabmenu = document.getElementById("tab");
    var tabcontent = document.getElementsByClassName("tab");
    var tablinks = document.getElementsByClassName("tab-links");
    let hoveredPolygonId = null;
    let clickedPolygonId = null;

    const mapSelect = document.getElementById('map-style');

    const uploadContainer = document.getElementById('frmFile');
    const fileInput = document.getElementById('fileInput');

    uploadContainer.addEventListener('dragover', handleDragOver);
    uploadContainer.addEventListener('dragleave', handleDragLeave);
    uploadContainer.addEventListener('drop', handleDrop);

    $("#polygon-color").spectrum({
        showPaletteOnly: true,
        togglePaletteOnly: true,
        togglePaletteMoreText: '더보기',
        togglePaletteLessText: '줄이기',
        color : polygonColor,
        palette: [
            ["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],
            ["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],
            ["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],
            ["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],
            ["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],
            ["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],
            ["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],
            ["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]
        ]
    });
    $("#line-color").spectrum({
        showPaletteOnly: true,
        togglePaletteOnly: true,
        togglePaletteMoreText: '더보기',
        togglePaletteLessText: '줄이기',
        color : lineColor,
        palette: [
            ["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],
            ["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],
            ["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],
            ["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],
            ["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],
            ["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],
            ["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],
            ["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]
        ]
    });

    function handleDragOver(e) {
        e.preventDefault();
        uploadContainer.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        uploadContainer.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        uploadContainer.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        $('#file_intro h4').remove()
        $('.comment').remove()

        if (files.length > 0) {
            for (i = 0; i < files.length ; i++) {
                fileName = files[i].name
                var html = ""
                html = "<div class='dropfile'>"+fileName+"<i class=\"fas fa-solid fa-xmark\" onclick='deleteFileList()'></i></div>"
                $("#file_intro").append(html)
                $("#shpData").prop("files", e.dataTransfer.files)
            }
        }
    }

    function deleteFileList() {

    }

    // 저장된 파일 고르는 함수
    $(document).ready(function() {
        $('.custom-select').click( function() {
            $('.options').fadeToggle();
        } )
    });

    // 맵박스 함수
    const map = new mapboxgl.Map({
        container: "map",
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [126.88271541564299, 37.48151056694073],
        zoom: 11,
    });
    const language = new MapboxLanguage();
    map.addControl(language);
    var draw = new MapboxDraw({});
    map.addControl(draw, 'bottom-left')

    // 메뉴 모드를 다크 모드 혹은 화이트 모드 바꾸는 함수
    function toggleWhiteMode() {
        var icon = document.getElementById("mdicon");
        var styleOption = document.getElementsByClassName("style-option");

        if (tabmenu.style.color === "#020202" || tabmenu.style.color === "" || tabmenu.style.color === 'rgb(2, 2, 2)') {
            // 화이트 모드에서 다크 모드로 전환 될때
            $("#tab, #map-style").css("color", "#ffffff");
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
            tabmenu.style.backgroundColor = "#666";
            for (i = 0; i < styleOption.length; i++) {
                styleOption[i].style.color = "white"
            }
        } else {
            // 다크 모드에서 화이트 모드로 전환 될때
            $("#tab, #map-style").css("color", "#020202");
            icon.classList.add('fa-moon');
            icon.classList.remove('fa-sun');
            tabmenu.style.backgroundColor = "#fff"
            for (i = 0; i < styleOption.length; i++) {
                styleOption[i].style.color = "black"
            }
        }
    }
    // Polyline 그리는 함수
    function drawPolyline(data) {
        let count = 0;
        for (const key in dataArr) {
            if (key.indexOf(data.fileName) > -1) {count++;}
        }
        if (count > 0 ) {
            data.fileName = data.fileName+'_'+count
        }

        dataArr[data.fileName] = data

        var tData = {
            type: 'geojson',
            data: {
                type : 'FeatureCollection',
                features :data.data.features
            }
        }

        setMapBounds(data.data);
        map.addSource("data_"+data.fileName, tData);
        map.addLayer({
            'id': 'polygons_'+data.fileName,
            'type': 'fill',
            'source': 'data_'+data.fileName,
            'paint': {
                'fill-color': polygonColor,
                'fill-opacity': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    1,
                    0.5
                ]
            }
        });

        map.addLayer({
            'id': 'outline_'+data.fileName,
            'type': 'line',
            'source': 'data_'+data.fileName,
            'layout': {},
            'paint': {
                'line-color': lineColor,
                'line-width': Number(lineWidth)
            }
        });

    }

    function drawNodePoint(data) {
        let count = 0;
        for (const key in nodeDataArr) {
            if (key.indexOf(data.fileName) > -1) {count++;}
        }
        if (count > 0 ) {
            data.fileName = data.fileName+'_'+count
        }

        nodeDataArr[data.fileName] = data

        var tData = {
            type: 'geojson',
            data: {
                type : 'FeatureCollection',
                features :data.data.features
            }
        }

        map.addSource("nodeData_"+data.fileName, tData);
        map.addLayer({
            'id': 'points_'+data.fileName,
            'type': 'circle',
            'source': 'nodeData_'+data.fileName,
            'paint': {
                'circle-radius': 6, // 점의 반지름 설정
                'circle-color': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    '#007dd2', // 클릭한 점의 색상
                    '#1aa3ff', // 클릭하지 않은 점의 색상
                ],
                'circle-opacity': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    1,
                    0.5
                ]
            }
        });
    }

    function drawLinkLine(data) {
        let count = 0;
        for (const key in linkDataArr) {
            if (key.indexOf(data.fileName) > -1) {count++;}
        }
        if (count > 0 ) {
            data.fileName = data.fileName+'_'+count
        }

        linkDataArr[data.fileName] = data

        var tData = {
            type: 'geojson',
            data: {
                type : 'FeatureCollection',
                features :data.data.features
            }
        }

        map.addSource("lineData_"+data.fileName, tData);
        map.addLayer({
            'id': 'lines_' + data.fileName,
            'type': 'line',
            'source': 'lineData_' + data.fileName, // 선의 데이터를 가리키는 소스
            'paint': {
                'line-color': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    '#007dd2', // 클릭한 선의 색상
                    '#1aa3ff', // 클릭하지 않은 선의 색상
                ],
                'line-width': 2, // 선의 너비 설정
                'line-opacity': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    1,
                    0.5
                ]
            }
        });
    }

    // 해당 탭을 여는 함수
    function openTab(event, tab) {
        if (event.currentTarget.className === "tab-links") {
            checkTab()
            document.getElementById(tab).style.display = "block"
            event.currentTarget.className += " active";
        } else {
            checkTab()
        }
    }

    function checkTab() {
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
    }

    // 열린 shp 파일(파일 이름, 파일 저장한 날)을 db에 저장하는 함수
    function saveShp(filename) {
        $.ajax({
            url : '/api/saveShp',
            type : 'POST',
            data : {
                shpName : filename
            },
            success : function (result){
                console.log(result)
                var shpId = result.shpId;

                for (var i = 0; i < dataArr[filename].data.features.length; i++) {
                    saveFeature(shpId, dataArr[filename].data.features[i], (i+1));
                }

                var html = ""
                html = "<a href='#' onclick='getShpData("+shpId+")'>"+filename+"</a>"
                $('.options').append(html)
            },
            error : function (error){
                console.log(error)
            }
        })
    }

    // 열린 shp 파일 내 Feature들을 db에 저장하는 함수
    function saveFeature(shpId, jsonObj, idx) {
        $.ajax({
            url : '/api/saveFeature',
            type : 'POST',
            dataType: 'json',
            contentType: 'application/json', // JSON으로 데이터를 전송함을 명시
            data: JSON.stringify({
                shpId: shpId,
                seq : idx,
                jsonObject: jsonObj
            }),
            success : function (result){
                console.log(result)
            },
            complete: function(xhr, status) {
                if (status === 'error' || !xhr.responseText) {
                    console.log('Network error or empty response.');
                }
            },
            error : function (error){
                console.log(error)
            }
        })
    }

    function getShpData(shpId) {
        $.ajax({
            url : "/api/getShp",
            type : "POST",
            data : {
                shpId : shpId
            },
            beforeSend: function( ) {
                viewLoading()
            },
            complete: function( ) {
                finishLoading();
            },
            success : function(data) {
                console.log(data.data)
                data.fileName = data.shpName
                drawPolyline(data);
                createLayer(data)
            },
            error: function () {
            }
        });
    }


    // 그려진 폴리곤라인 지도 내에 한눈에 보이도록 하는 함수
    function setMapBounds(data) {
        var bounds = new mapboxgl.LngLatBounds();
        data.features.forEach(function (feature) {
            var coordinates = feature.geometry.coordinates[0];
            coordinates.forEach(function (coordinate) {
                bounds.extend(coordinate);
            });
        });

        // 바운더리에 맞게 지도 조정
        map.fitBounds(bounds, { padding: 150 });
    }

    // 로딩 화면
    function viewLoading() {
        $('#loading-window, .loading-logo').show();
        document.getElementById("map").style.position = "absolute";
    }

    // 로딩 종료
    function finishLoading() {
        $('#loading-window, .loading-logo').hide();
        document.getElementById("map").style.position = "";
    }

    // 리스트에 db에 저장된 파일 가져오는 함수
    function sendFiles() {
        var frmFile = $("#frmFile");
        // 파일 선택 input 요소
        var fileInput = frmFile.find("input[name='shpData']")[0];

        // 선택한 파일 가져오기
        var files = fileInput.files;
        var formData = new FormData();

        hasShp = false
        hasShx = false
        hasDdf = false

        for (var i = 0; i < files.length; i++) {
            if (files[i].name.indexOf('.shp') > -1) {
                hasShp = true
            } else if (files[i].name.indexOf('.shx') > -1) {
                hasShx = true
            } else if (files[i].name.indexOf('.dbf') > -1) {
                hasDdf = true
            }
        }

        if (hasShp === true && hasShx === true && hasDdf === true) {
            for (var i = 0; i < files.length; i++) {
                formData.append('shpData', files[i]);
            }
        } else {
            alert ("필수 파일을 확인해주세요.")
        }

        $.ajax({
            url: '/api/uploadShapeFiles',  // 서버 엔드포인트
            type: 'POST',
            data: formData,
            processData: false,  // 필수: FormData를 query string으로 변환하지 않음
            contentType: false,  // 필수: 파일 전송에는 multipart/form-data 형식이 필요
            beforeSend: function( ) {
                viewLoading()
            },
            complete: function( ) {
                finishLoading();
            },
            success: function (data) {
                /* geojson 형식
                * Point: [longitude, latitude]
                * LineString: [[longitude1, latitude1], [longitude2, latitude2], ...]
                * Polygon: [[[longitude1, latitude1], [longitude2, latitude2], ...], ...]
                */
                const dataType = checkDataType(data);
                if (dataType === "Point")  {
                    // nodeDataArr 에 정보를 담는다
                    if (data.crs.indexOf("EPSG:4326") === -1) {
                        // 변환된 좌표 데이터로 작업 수행
                        const wkt = data.crs;

                        // WKT 형식의 CRS를 Proj4js로 변환하여 CRS 객체를 생성합니다.
                        const crs = proj4(wkt);

                        data.data.features.forEach(feature => {
                            const transformedCoordinates = proj4(crs, 'EPSG:4326', feature.geometry.coordinates);
                            feature.geometry.coordinates = transformedCoordinates;
                        });
                    }
                    drawNodePoint(data);
                } else if (dataType === "MultiLineString") {
                    // linkDataArr 에 정보를 담는다
                    if (data.crs.indexOf("EPSG:4326") === -1) {
                        // 변환된 좌표 데이터로 작업 수행
                        const wkt = data.crs;

                        // WKT 형식의 CRS를 Proj4js로 변환하여 CRS 객체를 생성합니다.
                        const crs = proj4(wkt);

                        data.data.features.forEach(feature => {
                            // 각 feature의 geometry.coordinates에 대해 proj4를 사용하여 좌표를 변환
                            feature.geometry.coordinates[0].forEach((coordinates, index) => {
                                const transformedCoordinates = proj4(crs, 'EPSG:4326', coordinates);
                                // 변환된 좌표를 해당 feature에 다시 할당
                                feature.geometry.coordinates[index] = transformedCoordinates;
                            });
                        });
                    }
                    drawLinkLine(data)
                } else {
                    drawPolyline(data);
                    createLayer(data);
                }
            },
            error: function (error) {
                console.error('Error uploading file:', error);
            }
        });
    }


    function removePolygon(key) {
        fileName = dataArr[key].fileName

        if (draw.getAll().length > 0) {
            draw.deleteAll();
        }
        map.removeLayer('polygons_'+fileName);
        map.removeLayer('outline_'+fileName);

        map.removeSource('data_'+fileName);
        $("#" + fileName).remove();

        for (i = 0; i < fileNmList.length; i++) {
            if (fileNmList[i] === fileName) {
                fileNmList.splice(i, 1)
            }
        }

        delete dataArr[key]

        if ($(".layer-file").length === 0) {
            $(".file-info-item").remove();
        }
    }

    function createLayer(data) {
        var html = "";
        var content = "";
        if ($(".file-info").length === 0) {
            html += '<div class="layer-file selected" id=\''+data.fileName+'\'>';
            selectedLayer(data.fileName);
        } else {
            html += '<div id='+data.fileName+' class="layer-file">';
        }
        html += '<input type="checkbox" id="check_'+data.fileName+'" onclick="showHideLayer(\''+data.fileName+'\')" checked >';
        html += '<div class="file-info" onclick="selectedLayer('+data.fileName+')">';
        html += '<div class="file-tit">'+data.fileName+'</div>';
        html += '</div>';
        html += '<div class="dropdown"> ' +
            '<i class="fa-solid fa-ellipsis-vertical" data-bs-toggle="dropdown"></i></button> <ul class="dropdown-menu">' +
            '<li onclick="saveShp(\''+data.fileName+'\')" class="dropdown-item">저장</li>' +
            '<li><hr class="dropdown-divider"></hr></li>' +
            '<li onclick="removePolygon(\''+data.fileName+'\')" class="dropdown-item">삭제</li>' +
            '</ul></div></div>'
        $(".layer-file-list").append(html);
        fileNmList.push(data.fileName)
    }


    function selectedLayer(obj) {
        if ($(".file-info").length === 0) {
            fileNm = obj
        } else  {
            var layer = document.getElementsByClassName("layer-file");
            for (i = 0; i < layer.length; i++) {
                layer[i].classList.remove("selected");
            }
            $(obj).addClass("selected")
            fileNm = $('.selected .file-tit').text()
        }
        $(".colors-item .sp-preview-inner").css("background-color", map.getPaintProperty('polygons_'+fileNm,'fill-color'))
        $(".line-item .sp-preview-inner ").css("background-color", map.getPaintProperty('outline_'+fileNm,'line-color'))
        $("#line-width").val(map.getPaintProperty('outline_'+fileNm,'line-width'))
        getProperties()
        openTab(event, 'tab3')
        tablinks[2].classList.add("active");
        // if (tabmenu.style.color === "#020202" || tabmenu.style.color === "" || tabmenu.style.color === "rgb(2, 2, 2)"){
        //     tablinks[2].classList.add("active-white");
        // } else {
        //     tablinks[2].classList.add("active-dark")
        // }
        for (i = 0; i < fileNmList.length; i++) {
            map.on('mousemove', 'polygons_'+ fileNmList[i], function () {})
            map.on('mouseleave', 'polygons_'+ fileNmList[i], function () {})
            map.on('click', 'polygons_'+ fileNmList[i], function () {})
            map.setPaintProperty('polygons_'+fileNmList[i],'fill-opacity', 0.5);
        }
        var opacity = ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0.5]
        map.setPaintProperty('polygons_'+fileNm,'fill-opacity', opacity);
        map.on('click', 'polygons_'+fileNm, function (e) {
            selectedShp = e.features[0]
            if (e.features[0].layer.id === 'polygons_'+fileNm) {
                var property = "";
                var id = selectedShp.properties.DIST1_ID;
                var info = dataArr[fileNm].data.features
                for (i = 0; i < info.length; i++) {
                    if (info[i].properties.DIST1_ID === id) {
                        property = info[i]
                    }
                }
                $('#'+ id).parent().addClass("selected")

                openTab(event, 'tab3')
                tablinks[2].classList.add("active");

                editShp(property)
            }
        });

        map.on('mousemove', 'polygons_'+fileNm, (e) => {
            selectedShp = e.features
            if (e.features[0].layer.id === 'polygons_'+fileNm) {
                if (selectedShp.length > 0) {
                    if (hoveredPolygonId !== null) {
                        map.setFeatureState(
                            { source: 'data_'+fileNm, id: hoveredPolygonId },
                            { hover: false }
                        );
                    }
                    hoveredPolygonId = selectedShp[0].id;
                    map.setFeatureState(
                        { source: 'data_'+fileNm, id: hoveredPolygonId },
                        { hover: true }
                    );
                }
            }

        });
        map.on('mouseleave', 'polygons_'+fileNm, () => {
            if (hoveredPolygonId !== null) {
                map.setFeatureState(
                    { source: 'data_'+fileNm, id: hoveredPolygonId },
                    { hover: false }
                );
            }
            hoveredPolygonId = null;
        });
    }

    function getProperties() {
        var info = dataArr[fileNm].data.features
        var html = ""
        if (info.length > 0) {
            $(".file-info-item").remove();
        }
        for (i = 0; i < info.length; i++) {
            html = "<div class='file-info-item' id = "+info[i].id+">" +
                "<div class='file-info-li' onclick='selectedProperty(this)' id ="+info[i].properties.DIST1_ID+">"+
                "<div class='info-id info-item'>"+info[i].properties.DIST1_ID+"</div>"+
                "<div class='info-gcode info-item'>"+info[i].properties.GCODE +"</div>"+
                "<div class='info-name info-item'>"+info[i].properties.NAME+"</div>"+
                "<div class='info-fname info-item'>"+info[i].properties.F_NAME+"</div>" +
                "</div>"+
                "<button type='button' class='info-btn btn-primary' data-bs-toggle='modal' data-bs-target='#myModal' onclick='changeProperties("+info[i].id+")'>수정</button>" +
                "</div>"
            $(".file-info-list").append(html)
        }
    }

    function selectedProperty(obj) {
        if (map.getLayoutProperty('polygons_'+fileNm, 'visibility') === 'none') {
            alert("선택하신 레이어가 지도에 없습니다")
        } else {
            var property = "";
            var id = obj.querySelector('.info-id').textContent;
            var info = dataArr[fileNm].data.features
            $(obj).parent().addClass("selected")
            for (i = 0; i < info.length; i++) {
                if (info[i].properties.DIST1_ID === id) {
                    property = info[i]
                }
            }

            // if ($(".polygon-properties").length > 0) {
            //     $(".polygon-properties").remove()
            // }
            // var html = "<div class='polygon-properties'> ID : "+property.properties.DIST1_ID +"<br>"+
            //     "시군구 : "+property.properties.F_NAME+"<br>"+
            //     "지역 코드 : "+property.properties.GCODE +"<br>"+
            //     "지역명 : "+property.properties.NAME +"</div>"
            // $(".property-list").append(html)

            editShp(property)
        }
    }
    var propertyArr = []

    function editShp(property) {
        if(draw.getAll().features.length > 0) {

        }
        map.removeLayer('polygons_'+(fileNm));
        map.removeLayer('outline_'+(fileNm));
        map.removeSource('data_'+(fileNm));
        var polygonArr = []
        drawArr = []

        propertyArr.push(property)

        for (i = 0; i < dataArr[fileNm].data.features.length; i++) {
            var found = false;
            for (j = 0; j < propertyArr.length; j++) {
                if (propertyArr[j].id === dataArr[fileNm].data.features[i].id) {
                    drawArr.push(dataArr[fileNm].data.features[i])
                    found = true;
                    break;
                }
            }
            if (!found) {
                polygonArr.push(dataArr[fileNm].data.features[i]);
            }
        }

        for (i = 0; i < drawArr.length; i++) {
            draw.add(drawArr[i])
        }
        polygon(polygonArr);
    }

    function finishPoint() {
        var item = document.getElementsByClassName("file-info-item");
        for (i = 0; i < item.length; i++) {
            item[i].classList.remove("selected");
        }
        if (draw.getAll().features.length > 0) {
            draw.getAll()
            for (i = 0; i < drawArr.length; i++) {
                dataArr[fileNm].data.features[drawArr[i].id-1]=draw.getAll().features[i]
            }
            map.removeLayer('polygons_'+(fileNm));
            map.removeLayer('outline_'+(fileNm));
            map.removeSource('data_'+(fileNm));
            polygon(dataArr[fileNm].data.features)
            draw.deleteAll();
            propertyArr = []
            drawArr = []
        } else {
            alert('편집된 부분이 없습니다')
        }
    }

    function polygon(data) {
        var tData = {
            type: 'geojson',
            data: {
                type : 'FeatureCollection',
                features : data
            }
        }
        map.addSource("data_"+fileNm, tData);
        map.addLayer({
            'id': 'polygons_'+fileNm,
            'type': 'fill',
            'source': 'data_'+fileNm,
            'layout': {},
            'paint': {
                'fill-color': polygonColor,
                'fill-opacity': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    1,
                    0.5
                ]
            }
        });
        map.addLayer({
            'id': 'outline_'+fileNm,
            'type': 'line',
            'source': 'data_'+fileNm,
            'layout': {},
            'paint': {
                'line-color': lineColor,
                'line-width': Number(lineWidth),
            }
        });

    }

    function showHideLayer(Nm) {
        if ($('#check_'+Nm).is(':checked') === true) {
            map.setLayoutProperty('polygons_'+Nm, 'visibility', 'visible');
            map.setLayoutProperty('outline_'+Nm, 'visibility', 'visible');
        } else {
            map.setLayoutProperty('polygons_'+Nm, 'visibility', 'none');
            map.setLayoutProperty('outline_'+Nm, 'visibility', 'none');
        }
    }

    // 지도 스타일 변경하는 함수
    mapSelect.onchange = (change) => {
        const changeId = change.target.value;
        map.setStyle('mapbox://styles/mapbox/' + changeId);
        // map.on('style.load', () => {
        //     for (i = 0; i < document.querySelectorAll('.file-tit').length; i++) {
        //         var Name = document.querySelectorAll('.file-tit')[i].textContent
        //         drawPolyline(dataArr[Name])
        //     }
        // });
    }
    var changeProper;
    function changeProperties(id) {
        changeProper = id
        $(".modal-body form").remove()
        var html =
            "<form method='POST'><label> ID  </label><input id ='proper-dist1id' type='text' value= "+$("#"+id+" .info-id").text()+"><br>"+
            "<label> 지역 코드 </label><input id ='proper-gcode' type='text' value= "+$("#"+id+" .info-gcode").text()+"><br>"+
            "<label> 시군구 </label><input id ='proper-name' type='text' value= "+$("#"+id+" .info-name").text()+"><br>"+
            "<label> 지역명 </label><input id ='proper-fname' type='text' value= "+$("#"+id+" .info-fname").text()+"></div></form>"
        $(".modal-body").append(html)
    }

    function finishProperties() {
        var data = dataArr[fileNm].data.features
        for (i = 0; i < data.length; i++) {
            if (data[i].id == changeProper) {
                data[i].properties["DIST1_ID"] = $('#proper-dist1id').val()
                data[i].properties["GCODE"] = $('#proper-gcode').val()
                data[i].properties["F_NAME"] = $('#proper-name').val()
                data[i].properties["NAME"] = $('#proper-fname').val()
                $("#"+changeProper+" .info-id").text($('#proper-dist1id').val())
                $("#"+changeProper+" .info-gcode").text($('#proper-gcode').val())
                $("#"+changeProper+" .info-name").text($('#proper-name').val())
                $("#"+changeProper+" .info-fname").text($('#proper-fname').val())
            }
        }
    }

    function finishProperties() {

    }

    function checkDataType(data) {
        // 대표로 첫번째 인덱스의 정보를 가져와서 타입 검사 실시
        var type = data.data.features[0].geometry.type
        return type
    }

    function changePolygonColor() {
        var polygon = $("#polygon-color").val()
        polygonColor = polygon
        for (i = 0; i < fileNmList.length; i++) {
            if(fileNm === fileNmList[i]) {
                map.setPaintProperty('polygons_'+fileNmList[i],'fill-color', polygonColor);
            }
        }
    }

    function changeLineColor() {
        var line = $("#line-color").val()
        lineColor = line
        for (i = 0; i < fileNmList.length; i++) {
            if(fileNm === fileNmList[i]) {
                map.setPaintProperty('outline_'+fileNmList[i],'line-color', lineColor);
            }
        }
    }

    function  changeLineThickness() {
        var line = $("#line-width").val()
        lineWidth = line
        for (i = 0; i < fileNmList.length; i++) {
            if(fileNm === fileNmList[i]) {
                map.setPaintProperty('outline_'+fileNmList[i],'line-width', Number(lineWidth));
            }
        }
    }

</script>
</html>